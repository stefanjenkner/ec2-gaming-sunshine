AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  MyIp:
    Description: Client IP address in CIDR notation
    Type: String
    Default: 84.160.201.227/31
  CloudConfig:
    Description: Base64-encoded cloud-config to be passed as UserData
    Type: String

Resources:
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-instance-role'
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${AWS::StackName}-instance-profile'
      Path: "/"
      Roles:
      - !Ref InstanceRole
  AdminAccessSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-admin-access'
      GroupDescription: Allow remote admin access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref MyIp
  GamingAccessSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-player-access'
      GroupDescription: Allow remote gaming access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 47984
          ToPort: 48031
          CidrIp: !Ref MyIp
        - IpProtocol: udp
          FromPort: 47998
          ToPort: 48015
          CidrIp: !Ref MyIp
  LaunchTemplate:
    Type: 'AWS::EC2::LaunchTemplate'
    Properties:
      LaunchTemplateName: !Sub '${AWS::StackName}-launch-template'
      LaunchTemplateData:
        IamInstanceProfile:
          Arn: !GetAtt
            - InstanceProfile
            - Arn
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            DeleteOnTermination: true
            SubnetId: subnet-b859bfc3
            Groups:
              - !GetAtt AdminAccessSecurityGroup.GroupId
              - !GetAtt GamingAccessSecurityGroup.GroupId
        PrivateDnsNameOptions:
          HostnameType: resource-name
        BlockDeviceMappings:
          - Ebs:
              VolumeSize: 10
              VolumeType: gp2
              DeleteOnTermination: true
              Encrypted: true
            DeviceName: /dev/sda1
        ImageId: ami-06ce824c157700cd2
        InstanceType: g4dn.xlarge
        KeyName: ec2-gaming
        InstanceMarketOptions:
          MarketType: spot
          SpotOptions:
            InstanceInterruptionBehavior: stop
            SpotInstanceType: persistent
        TagSpecifications:
          - ResourceType: instance
            Tags:
              -  Key: Name
                 Value: !Sub '${AWS::StackName}-instance'
        UserData: !Ref CloudConfig

Outputs:
  LaunchTemplateId:
    Value: !Ref LaunchTemplate
  LaunchTemplateLatestVersionNumber:
    Value: !GetAtt LaunchTemplate.LatestVersionNumber
